version: 2.1

jobs:
  build-service:
    docker:
      - image: alexfalkowski/go:1.22-ruby
    working_directory: ~/konfig
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - run: make setup
      - run: make lint
      - run: make proto-breaking
      - run: make sec
    resource_class: large
  build-docker:
    docker:
      - image: alexfalkowski/go:1.22-ruby
    working_directory: ~/auth
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - setup_remote_docker
      - run: make build-docker
      - run: make trivy
    resource_class: large
  features-grpc:
    docker:
      - image: alexfalkowski/go:1.22-ruby
      - image: localstack/localstack:2.3
        environment:
          SERVICES: s3,ssm
      - image: hashicorp/vault:1.15
        environment:
          VAULT_DEV_ROOT_TOKEN_ID: vault-plaintext-root-token
      - image: alexfalkowski/auth:latest
        command: server
        environment:
          CONFIG_FILE: yaml:CONFIG
          CONFIG: ZW52aXJvbm1lbnQ6IHByb2R1Y3Rpb24KZGVidWc6CiAgcG9ydDogNjA2MApjYWNoZToKICByaXN0cmV0dG86CiAgICBudW1fY291bnRlcnM6IDEwMDAwMDAwCiAgICBtYXhfY29zdDogMTAwMDAwMDAwCiAgICBidWZmZXJfaXRlbXM6IDY0CmNhc2JpbjoKICBtb2RlbDogfAogICAgW3JlcXVlc3RfZGVmaW5pdGlvbl0KICAgIHIgPSBzdWIsIG9iaiwgYWN0CgogICAgW3BvbGljeV9kZWZpbml0aW9uXQogICAgcCA9IHN1Yiwgb2JqLCBhY3QKCiAgICBbcG9saWN5X2VmZmVjdF0KICAgIGUgPSBzb21lKHdoZXJlIChwLmVmdCA9PSBhbGxvdykpCgogICAgW21hdGNoZXJzXQogICAgbSA9IHIuc3ViID09IHAuc3ViICYmIHIub2JqID09IHAub2JqICYmIHIuYWN0ID09IHAuYWN0CiAgcG9saWN5OiB8CiAgICBwLCBkZXZlbG9wZXIsIGtvbmZpZywgZ2V0LWNvbmZpZwpoZWFsdGg6CiAgZHVyYXRpb246IDFzCiAgdGltZW91dDogMXMKa2V5OgogIGVkMjU1MTk6CiAgICBwdWJsaWM6IElSdnFBb1E0WVdxcVRMMklVUnVjUGJKSFZTTHcwL0lXTEN6dnJpSGxoZmM9CiAgICBwcml2YXRlOiBFeExQRklpT0xCNmZsbEMwTHlzZVV5aXdFeXU0MDNqK3ZrMkdEMXYyTEtVaEcrb0NoRGhoYXFwTXZZaFJHNXc5c2tkVkl2RFQ4aFlzTE8rdUllV0Y5dz09CiAgcnNhOgogICAgcHVibGljOiBNSUlDQ2dLQ0FnRUFycjd3WER0NjR4R21wT1V0ZS9DaVdvMmxrMTNzYXhJTjUrcDJibGF0d3pmVW1XbEVTMDFXWGg5NXJiN2V6cis5YTZSVkVvSjlWNnVFT0Q4cUxlb0hCWUl6TG9CN3dydE5BbE9YRVk0bmlxekZvVlVzaXU2UnN0ZjQ1K3V1VDFKZzI3dG41cFJQRTVMUUdnTGZSdytyTm1COXByVS9yK0dvams5UUcyNGNOZi8wTTB2bk9aNHQyTC9mU1FvN1hYZDNVN0FzRzRyMWFlbkd5b1B3ZVZnTVl5LzgvOEs5WllDTHdyY0lLWXFOek9YK0pGQTdhR2g5TnNxUVlNU0lKaGFmS2xQSGxwRmljVWtyY1BrZlBUYllNWWF1ODJmTGFodE43eDAvMittY3cvOUc3M1M0ZDVSaDZDRmdxVWdPemk4RlV2ZmFxL2U0MkFNQmZHUHVwNDgxcUNlMkt4c0UvN29CNWVEUkFPdXNaQ284M3g5dVY1QmpMb2txVFhsOVdjbWM3VzkwSjN1bkxFTyttckdVWmhDc3d6dUVSZ2ZnN2EyVzI1eDRQQWYyOWhlNnhqRVlDaGlWK0Y3V1JIVVE4RldqVkFCbkliNlVTTUtXK2FCN2tsQno1ZkNlYUR0YlhURUd2MDFYaDl4YjZtKzQvUm1tYmZWYnI5dGh3OVFpVlk1bUpBMEZxRjJyNFQ2ek1SSGt2bVQrVHQ1QU1IbkZkekpXUlhUQVRWQ0pmeENxSU1DeDk0aWZxN2M4U05xdDhqNzJ4ampzTGxhQzVQRUVDSi9ka0pydWhSU1pzOGFJU2V2QklkdkplVmgvTU1kYWppeVFvdlZqSFc4V1JId2dGcmYyUmwwdDBnM2xzR3FBR1EycXp5NnNOYzI3K3VsOWIyWW83SllFclc1em4ya0NBd0VBQVE9PQogICAgcHJpdmF0ZTogTUlJSktBSUJBQUtDQWdFQXJyN3dYRHQ2NHhHbXBPVXRlL0NpV28ybGsxM3NheElONStwMmJsYXR3emZVbVdsRVMwMVdYaDk1cmI3ZXpyKzlhNlJWRW9KOVY2dUVPRDhxTGVvSEJZSXpMb0I3d3J0TkFsT1hFWTRuaXF6Rm9WVXNpdTZSc3RmNDUrdXVUMUpnMjd0bjVwUlBFNUxRR2dMZlJ3K3JObUI5cHJVL3IrR29qazlRRzI0Y05mLzBNMHZuT1o0dDJML2ZTUW83WFhkM1U3QXNHNHIxYWVuR3lvUHdlVmdNWXkvOC84SzlaWUNMd3JjSUtZcU56T1grSkZBN2FHaDlOc3FRWU1TSUpoYWZLbFBIbHBGaWNVa3JjUGtmUFRiWU1ZYXU4MmZMYWh0Tjd4MC8yK21jdy85RzczUzRkNVJoNkNGZ3FVZ096aThGVXZmYXEvZTQyQU1CZkdQdXA0ODFxQ2UyS3hzRS83b0I1ZURSQU91c1pDbzgzeDl1VjVCakxva3FUWGw5V2NtYzdXOTBKM3VuTEVPK21yR1VaaENzd3p1RVJnZmc3YTJXMjV4NFBBZjI5aGU2eGpFWUNoaVYrRjdXUkhVUThGV2pWQUJuSWI2VVNNS1crYUI3a2xCejVmQ2VhRHRiWFRFR3YwMVhoOXhiNm0rNC9SbW1iZlZicjl0aHc5UWlWWTVtSkEwRnFGMnI0VDZ6TVJIa3ZtVCtUdDVBTUhuRmR6SldSWFRBVFZDSmZ4Q3FJTUN4OTRpZnE3YzhTTnF0OGo3MnhqanNMbGFDNVBFRUNKL2RrSnJ1aFJTWnM4YUlTZXZCSWR2SmVWaC9NTWRhaml5UW92VmpIVzhXUkh3Z0ZyZjJSbDB0MGczbHNHcUFHUTJxenk2c05jMjcrdWw5YjJZbzdKWUVyVzV6bjJrQ0F3RUFBUUtDQWdCelQwL3dyTmRFYTJ0WnVGa3hSZkw4YWlmdWZMWDdXV2lQdHVuN21Yc0VMUjAvTm5WNGMwb2d4Z2hYSEhLT1gzd3hRYmxaZzM0T2tnR24xQmFUUWJEc2M2UXVkVjQxZTc4dlg5VjZJaUg1b2xTdlJ6TWpZcFlHTy9ubG9HSGZ1ZTVzVU5nWkVaaTB3OVpLczhaK2I5cDlBV01vMU1WMzNDS0w5YzVZcTJvMlAvWDJ1NG1UUGN2bkVZWFgvc1o1d05HZkNjdXhTUnIwanUwOHlaK3ZrdWhwczByeHdxR1VEeVVxa2ZqeTRKajlzbTducTRIb1Bic1Nvc3h1N29FaEVTQnFuK28rY3lWUXVBWFFnTE9hZzB4YU1oUFVUcE91S3VKY2ZTS2NqU1dET0RxbzNJNjFhZGJKaE96eUI3aXRXZDNiaCs1bU9BdGpqMmcxbXdQcTBkZUhUT2UvODV0S0VtcVZGTk5DRkpIYzNrQ2tJaDBRUDNFMGVYMHkxSmxVSVVodWVoeUJBTzBtM05aMkNqbnMwVmlyS3ZsRnNqUGFNUUdsLzlHSXZjcTc3Si9lSDVPVk9pU0tDeGc0cnNiblB3a01IZERCbTRHZThaLzZJVnFhMzRia0xQNlBmRTdmQXVpWmx6eG9JL1FUMVEwMXhENEhmQ0ppUmQzeXVud2IrdnpSUEtkMU0xY1JKTVlSbWhxVFJsTVZtYkV1dmN2LzhYSXJzUXVMd1BSK3ViZU1rdSt6L21Zc09PaWs0TnY1SmhmaXJ3anpZL1JoaGdlM2c5Q3VuSlBrVjF0MVdVNTY0RHo4aU9mQjVPMlZqcnViU1orUW9kRmVkdnFFY3JSaXNzQkhDSnhKMERnL0RxTW1BSHhLQ1lLMGVNdWE3ODV1Y2hIR0xGTnk1UFlRQVFLQ0FRRUF3K2FKcXdkaXNqRmhieUJ1TTRMM05TRlFQRlhhMlVJWDRuM0FTTGh4WEVOWTZ3Q3BKSk5wbHFpcUdFZWlmSkwySEFLUEdxcWxyektUczBaQVpjOU9Ua0NITjNadXB5WEwxVFFBS2l4RmlxSlBHbkp6MGgwZnAzdXBZOVZJY3dudVBSdTNLQ1ExVTJvNVlMVjhnaG4vWkpnZ2E3OXBlWWpuclJYTGZSTzFwalJnRjdOTi85NHhyZnpTYnJQVXUwVlQrWFF0VDRpckhHU2dUWnlRc1FpUm5QUFB4RXY0S0xRYmJNMkJtb3JtRm9GTjYzVFFvcWVXbVo2ck81OXpBQSt1cmQrS3RIUUg2cjB1VEhleDFDcTduUmVUd0U3UmlMNzF4TXJXSVdYT21KTnpubFlxOWltdmczVnk1YThpOWplOFd4ejZuL1BnSzBEUW90ZlJXY1IwYVFLQ0FRRUE1RnI1TktJWkVuRTU2Mmd4eDlsaVFRd25LN3Z6RWJ6ODk3Y3hjQU56U1RtZG1FbTB5czROWHJiQ1NwM1BMR2RrZzN5TWRseExjaGo5TzJ2cnY4ZWhCTTRpYkJJM285REg5eVV5dzdvZDVQMUliNkVTOVZCZlhwN1dTT2tocm9VajhmVks4ZENZcTlwMmp0ZXVDSlBHcEpnbVFHb09UeTJvVi9nM09rSlY4TlVUSGwwKzl6YitOdDUzaTlUSWpoeUFUanVNSFphNnlyZDQ0UFlJV0FwY0FYQXF4eDdFWkJZclhkc1Z3bTlCdE9ER3VHYUhNWnBHc05pUU9HQ0hvVG1qbW9CYmFCU1dsMVBLYTBwNFJkVm9hWThtM0RFdXNwWmxaSnBnNk4xZGJUQVIxT0VXQ1FlWjlIMWhINnVUdi8rRHZTOG9TS0VrUzRvZHNJN2JsTVJ6QVFLQ0FRQU1DQWVpZW1Ta1h3WUY1aTcrZU9lbjJyRHIwN1lLSzlYOXNnMXlLZW5FYWRwM0xHWTIrZHE5UndTVFV5cjJqYXdSMGxKcHA5dGZKRE1RQ3B0LzVUaUE4OU9hSTJydVZ4THF1RFBlWXpPdUxRUEFzeERMOGIvMDhGSlo4RXB2emtkVWQzUkxRZFlJbG5pSnFQdkpuY0VpczNraVJQSThaWjBjOHo2NUl0SEFNRzFLWjFlK0JDNTI2aFVlZVdyeVNYSzcybGZDRDdtNmw2K0V0TDNxTVlXSDV5MTJkOWY0My83ak1zZm43dW5zcmVwVU1LdHpvZWxNN0FMR09hZTlkRGtkTXFKNUxMc2p2cFN1VzVlUFdVU0doR0V0cVdtVEJXOWdzN2hzK3F5eWtEUEVvTFFveEN5a1hUMCtRQUJjc05XZm51c0JrZC9OcUVCb0Qrc3FvVGNwQW9JQkFEa21rNHdhclkreUNyN2gydU9iZ2oycFh2eFJFNnB5MUJUaklscFlZcmdHMVd4UnRnK3p0aURvT0lRWUxzdDhMT25EZUJ2L1NWcUs2b1crb3NmaW5HZnBkeS80OXpmbWZzVlo1L1NZVmZjRGRPZUxOb1Z5MGd1S1VUTDZOZFhKdUk5THhxL3lkdU03ejhROE1uQXZHOTRCdmtFTXlmd0MvMGpVOUcxK1FLZi9pOE5qcnVpTU9OOWVtaWpDM2xiQ3gxSE5FV291V1IxM0FhZTdxNmJ0SU0yelZ1Rnl6OUFFeEdHKy9Sa21ZeGx6MEFoQ2tMOVhUeTNmWldqV3I5c240OHc5SjZOSzA4Mlh5T2RGUWdpb09uT0F3a2NGZ0J4dUMzNDhMTmphM2hEL29OYllabjFvQzUzbTZ6SFQ3U3gyTkhCYXB3aFdYQkVUeGc1MEVueVBGZ0VDZ2dFQkFLaWNZd0FVOWpWU282Qlk2d0tJNG9lbFRqNFRKWXZQRCtPeVNVOEx5MzRtNk95SXNNL1ltY1I1TmNlWGFiMmJBWU45QnZXK2NZeElvZGV0dmxzU29hckN6aVBXb1hidEM4aS9xcWdidXk4cjY1b2d6TzVzZDdmNllkb3kzTDZuZTFEY2ptcHdPOFV1WlNRNFBrMFhwY0d0RWRMaGdLYXJhc1JFWWxWcThaNHhTbTk3QzgzTEdKdGh5dUQxUUFwdS8vME9wMVdGWWpqUXBweVhuOW5VMTJRZTVlbDBkY2ZPREtTMDluVGdYUDhPUGtHeVlsNkwrdVA4d2V1eDJGUUpibGNhdm9YSlBtUkpiajlNVXFORWtjaVIyR3QvWkJ3NzBPRHlkb0dIb1BWa0VQUHdSclY3dkxKUmdHcjBzWGlKOTVRSEVNbnU4enZySm9tdndBSy9DcTg9CnNlcnZlcjoKICB2MToKICAgIGlzc3VlcjogaHR0cHM6Ly9hdXRoLmZhbGtvd3NraS5pbwogICAgYWRtaW5zOgogICAgICAtIGlkOiBhZG1pbgogICAgICAgIGhhc2g6ICQyYSQxMCRnRE5nRXVkQmUud0pkN2NadEJxOXR1QUZwSHZYdXplcnZ5bG01OTNWWTdQdDRPOUkuekpFbQogICAgICAgICAgICAgICMgTUNaeEwkWTViZXlwQVdqPEpRRU5mdEBQX0RYVnVoIyxdMDJycTFId2Q2OW1GZyhSfDdjaSZUbGFvQlU4azNzNAogICAgc2VydmljZXM6CiAgICAgIC0gaWQ6IGUxNjAyZTE4NWNiYTJhOTBkOGJiY2ZjM2YzYzU1MzBjCiAgICAgICAgbmFtZTogZGV2ZWxvcGVyCiAgICAgICAgaGFzaDogJDJhJDEwJGJpbVVJNU0vcGtSWWdJQzNVSHpneS5jWmpGZXROdmd0M3ZHLlNQVlFSc3FVOE9GYjhWOVVHCiAgICAgICAgICAgICAgIyB1Qz9NeHdLTytyMUAwUlhbcThWNXM0Rnwzb1EpeVo3VFlEbFVIbUlmZU5uOUUmU2NMMlBre2ckcGldejZiQnRhCiAgICAgICAgICAgICAgIyBQRTcrMU1kRkxQa3diM0JDVEVZeGVzQ3NkOTZiYiszY2ZaYk9iYmlqV09zUTM5SHR2bFFFOVR1cHREcnVyV09lRDRnamh4elAxZUdFRjdBOENFOWRkTDFnVWV1bHZXWUoxNk1Lb2crUm9zYnN4azNkemU1ajF5eGhSaU16aEg0YkllNE12Q0hkaTJOUElSYlQ3cVFjakJIcjA0S3VIak8ycVl5YTM5OGtNdUZxNVhlenBsMXV2djdpZGNwUFFtZ1Q2dkt6RkgxNGhWRlIxUjFTMUFCQ2U3eDJGd3hsNnhEamFldG9KN3ZycFZ3d2JxT0xsNzlMNVU5OFFHeUFIVkUxa3hFa3Vyc1BRQkdhN3JiM3MwTEhBUUNKT3hTNmRhZVY2WGtiZC95NHJDMkwrNjV4ZkIyRkFNWnR2ZytiWCtUcjZTNEV5UXlRdDBHZkp2WC84Y055NlROMjFVRzczRk5FazNUWUl6NDZKQWhSYUdrMkF0bjQrQU8zNVlwejc1b3ZaZ2huOHNuQWtTU05qZVpNblRGS2YwdU5JUzZXL3hVTFpjYVpueFlLWXd3anhzVHdHc00vSDk3bjJZcWJhRU96RzRmVTY5bUpzejBLd0EvMlRFMWFxaGI1SHBmMkdiSlZ4b043QWtOcDZrUm1tdWZNc3NabHVYQzVYZCtiS1NyTnNLMnl6eEFnUHJWN1gveElmcWVKWjY1M1ZwNkhldk43RzQxalF1WEJYY2duNG5udWJuZitmLzNDeXZCcEljd205T29WRkZnYjBDNjBuWkZNbVNleC95YzZFd2FSUCs5RUVFU3p0Q3pYK1c5a04wZk5IQ25xMityWXNWZmM0d1pWbFFxMGFSZ3RsMWs5dW1HSTFpa2pHd1dhSjh1d214U09KSFB5ZzZ4Rm1Ebz0KICAgICAgICBkdXJhdGlvbjogMjRoCiAgICAgIC0gaWQ6IDdlOGMyNDM3OTkzMGQxMDdiMmQyODFhYTIzMjQ3MDkyCiAgICAgICAgbmFtZToga29uZmlnCiAgICAgICAgaGFzaDogJDJhJDEwJEhzSHFLZmlFdzh4U2F2Yk4uRUF0Vi5DcXMuMTdtLmh5N3ZWaktreUZVN0ROcnRlRGFETEtpCiAgICAgICAgICAgICAgIyBLdDhHUWtyLzYxcSpiUjp5Rkk3MlhuYTBATUN2cCRPXTM5bSlaSmZ4Tjw0fVNEc0VUSGheV2U1UGdCaW9kVWxjCiAgICAgICAgICAgICAgIyBpRXpIalJwRDgvc0VNekNGUEEwSnFVL0l0YUJQWndZbHNhNlc1M3ZIeTZ5eTNNaURrYmJoRGFwSGxqUjVJKzNNenBoN2pUcXJsQk1BREQxVGRKUFZBd010VWdmV013b0lReXBGUHFGWVcyaVh2VHRDejFxNHdsb1RKcCtQVG9JSS9RMzdWT3lYMjZTTitwT3NWaDJRYXhFZzJlT0lHSUF4Y2k0bEJKNE1uWnZyYllzRHRLV05NMWZtMEpxUFl0UjZmcnB0OVl5eFA0WDFkUUc5NTNlWUZ4TE1sZStTRWkrRWg1TlVlSXBZVlRuSFc2L1VVdGtlTnJKN0dabXo1UkhDaW4ySTVjY2QzRXV1K0NuY0M4Nyt6ZW5pU1dRZE00U3gxbXJ4SlFURjQvYkd4ZjYyOXdwSnpuNWFoMW9DMU5qd3Z3VWpkRlFLV0lVM21NbERRVjdxQ3JvTFBUbzdORkU2THBIT3huYTVQeDhzNnFMV25MR1FER0NZSzZZVUxGcXh0UWZscERBR0dwTEg0Wlh3THFwaXNrT1p3MjJ1eGdvUmxRTHBoSVFMZnhhNUkxUGRrL1RMaFNRYWRhY1k4OE95bTg4bWZnSS94VFJUVzY5Q2huYlRMbnd1NjVPV3F6SzhTZzdqa1YrYmVNWkw0OUIxMDA4QkdhdC83dHJ1QzFmWUpmUEdKRWV0TmlPUzRvNEkrMDVxV2VEcyszWGF5SVRmODczajF5aGo4dVpVTG1CcUVZaERTcnBKYm5zd0Rwc3k5R3dHM1dyRS9sa3dNN3lwNDNvWjM1YmNNSm5leU1rVGhDUmlnTWdpUEhJUzQwdUpHUXBYenNXRVZyQkdqbEFsMVBvQllYeGF4RDV3cnF2dWVtUk9HZHN3S3hRNlRoNW5mMVk1TFhHcHhlRT0KICAgICAgICBkdXJhdGlvbjogMjRoCnRlbGVtZXRyeToKICBsb2dnZXI6CiAgICBsZXZlbDogaW5mbwogIHRyYWNlcjoKICAgIGhvc3Q6IGxvY2FsaG9zdDo0MzE4CiAgICBzZWN1cmU6IGZhbHNlCnRva2VuOgogIGtpbmQ6IGF1dGgKdHJhbnNwb3J0OgogIGh0dHA6CiAgICBwb3J0OiA1MDAwCiAgICB1c2VyX2FnZW50OiAiQXV0aC1zZXJ2ZXIvMS4wIGh0dHAvMS4wIgogICAgcmV0cnk6CiAgICAgIHRpbWVvdXQ6IDEwcwogICAgICBhdHRlbXB0czogMwogIGdycGM6CiAgICBlbmFibGVkOiB0cnVlCiAgICBwb3J0OiA1MDAxCiAgICB1c2VyX2FnZW50OiAiQXV0aC1zZXJ2ZXIvMS4wIGdycGMvMS4wIgogICAgcmV0cnk6CiAgICAgIHRpbWVvdXQ6IDEwcwogICAgICBhdHRlbXB0czogMwo=
    working_directory: ~/konfig
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - run: dockerize -wait tcp://localhost:8200 -wait tcp://localhost:4566 -wait tcp://localhost:5001 -timeout 1m
      - run: make setup
      - run: make feature=features tags=@grpc features
      - store_artifacts:
          path: test/reports
      - run: make -C test leave-coverage
      - persist_to_workspace:
          root: test
          paths:
            - reports
    resource_class: large
  features-http:
    docker:
      - image: alexfalkowski/go:1.22-ruby
      - image: localstack/localstack:2.3
        environment:
          SERVICES: s3,ssm
      - image: hashicorp/vault:1.15
        environment:
          VAULT_DEV_ROOT_TOKEN_ID: vault-plaintext-root-token
      - image: alexfalkowski/auth:latest
        command: server
        environment:
          CONFIG_FILE: yaml:CONFIG
          CONFIG: ZW52aXJvbm1lbnQ6IHByb2R1Y3Rpb24KZGVidWc6CiAgcG9ydDogNjA2MApjYWNoZToKICByaXN0cmV0dG86CiAgICBudW1fY291bnRlcnM6IDEwMDAwMDAwCiAgICBtYXhfY29zdDogMTAwMDAwMDAwCiAgICBidWZmZXJfaXRlbXM6IDY0CmNhc2JpbjoKICBtb2RlbDogfAogICAgW3JlcXVlc3RfZGVmaW5pdGlvbl0KICAgIHIgPSBzdWIsIG9iaiwgYWN0CgogICAgW3BvbGljeV9kZWZpbml0aW9uXQogICAgcCA9IHN1Yiwgb2JqLCBhY3QKCiAgICBbcG9saWN5X2VmZmVjdF0KICAgIGUgPSBzb21lKHdoZXJlIChwLmVmdCA9PSBhbGxvdykpCgogICAgW21hdGNoZXJzXQogICAgbSA9IHIuc3ViID09IHAuc3ViICYmIHIub2JqID09IHAub2JqICYmIHIuYWN0ID09IHAuYWN0CiAgcG9saWN5OiB8CiAgICBwLCBkZXZlbG9wZXIsIGtvbmZpZywgZ2V0LWNvbmZpZwpoZWFsdGg6CiAgZHVyYXRpb246IDFzCiAgdGltZW91dDogMXMKa2V5OgogIGVkMjU1MTk6CiAgICBwdWJsaWM6IElSdnFBb1E0WVdxcVRMMklVUnVjUGJKSFZTTHcwL0lXTEN6dnJpSGxoZmM9CiAgICBwcml2YXRlOiBFeExQRklpT0xCNmZsbEMwTHlzZVV5aXdFeXU0MDNqK3ZrMkdEMXYyTEtVaEcrb0NoRGhoYXFwTXZZaFJHNXc5c2tkVkl2RFQ4aFlzTE8rdUllV0Y5dz09CiAgcnNhOgogICAgcHVibGljOiBNSUlDQ2dLQ0FnRUFycjd3WER0NjR4R21wT1V0ZS9DaVdvMmxrMTNzYXhJTjUrcDJibGF0d3pmVW1XbEVTMDFXWGg5NXJiN2V6cis5YTZSVkVvSjlWNnVFT0Q4cUxlb0hCWUl6TG9CN3dydE5BbE9YRVk0bmlxekZvVlVzaXU2UnN0ZjQ1K3V1VDFKZzI3dG41cFJQRTVMUUdnTGZSdytyTm1COXByVS9yK0dvams5UUcyNGNOZi8wTTB2bk9aNHQyTC9mU1FvN1hYZDNVN0FzRzRyMWFlbkd5b1B3ZVZnTVl5LzgvOEs5WllDTHdyY0lLWXFOek9YK0pGQTdhR2g5TnNxUVlNU0lKaGFmS2xQSGxwRmljVWtyY1BrZlBUYllNWWF1ODJmTGFodE43eDAvMittY3cvOUc3M1M0ZDVSaDZDRmdxVWdPemk4RlV2ZmFxL2U0MkFNQmZHUHVwNDgxcUNlMkt4c0UvN29CNWVEUkFPdXNaQ284M3g5dVY1QmpMb2txVFhsOVdjbWM3VzkwSjN1bkxFTyttckdVWmhDc3d6dUVSZ2ZnN2EyVzI1eDRQQWYyOWhlNnhqRVlDaGlWK0Y3V1JIVVE4RldqVkFCbkliNlVTTUtXK2FCN2tsQno1ZkNlYUR0YlhURUd2MDFYaDl4YjZtKzQvUm1tYmZWYnI5dGh3OVFpVlk1bUpBMEZxRjJyNFQ2ek1SSGt2bVQrVHQ1QU1IbkZkekpXUlhUQVRWQ0pmeENxSU1DeDk0aWZxN2M4U05xdDhqNzJ4ampzTGxhQzVQRUVDSi9ka0pydWhSU1pzOGFJU2V2QklkdkplVmgvTU1kYWppeVFvdlZqSFc4V1JId2dGcmYyUmwwdDBnM2xzR3FBR1EycXp5NnNOYzI3K3VsOWIyWW83SllFclc1em4ya0NBd0VBQVE9PQogICAgcHJpdmF0ZTogTUlJSktBSUJBQUtDQWdFQXJyN3dYRHQ2NHhHbXBPVXRlL0NpV28ybGsxM3NheElONStwMmJsYXR3emZVbVdsRVMwMVdYaDk1cmI3ZXpyKzlhNlJWRW9KOVY2dUVPRDhxTGVvSEJZSXpMb0I3d3J0TkFsT1hFWTRuaXF6Rm9WVXNpdTZSc3RmNDUrdXVUMUpnMjd0bjVwUlBFNUxRR2dMZlJ3K3JObUI5cHJVL3IrR29qazlRRzI0Y05mLzBNMHZuT1o0dDJML2ZTUW83WFhkM1U3QXNHNHIxYWVuR3lvUHdlVmdNWXkvOC84SzlaWUNMd3JjSUtZcU56T1grSkZBN2FHaDlOc3FRWU1TSUpoYWZLbFBIbHBGaWNVa3JjUGtmUFRiWU1ZYXU4MmZMYWh0Tjd4MC8yK21jdy85RzczUzRkNVJoNkNGZ3FVZ096aThGVXZmYXEvZTQyQU1CZkdQdXA0ODFxQ2UyS3hzRS83b0I1ZURSQU91c1pDbzgzeDl1VjVCakxva3FUWGw5V2NtYzdXOTBKM3VuTEVPK21yR1VaaENzd3p1RVJnZmc3YTJXMjV4NFBBZjI5aGU2eGpFWUNoaVYrRjdXUkhVUThGV2pWQUJuSWI2VVNNS1crYUI3a2xCejVmQ2VhRHRiWFRFR3YwMVhoOXhiNm0rNC9SbW1iZlZicjl0aHc5UWlWWTVtSkEwRnFGMnI0VDZ6TVJIa3ZtVCtUdDVBTUhuRmR6SldSWFRBVFZDSmZ4Q3FJTUN4OTRpZnE3YzhTTnF0OGo3MnhqanNMbGFDNVBFRUNKL2RrSnJ1aFJTWnM4YUlTZXZCSWR2SmVWaC9NTWRhaml5UW92VmpIVzhXUkh3Z0ZyZjJSbDB0MGczbHNHcUFHUTJxenk2c05jMjcrdWw5YjJZbzdKWUVyVzV6bjJrQ0F3RUFBUUtDQWdCelQwL3dyTmRFYTJ0WnVGa3hSZkw4YWlmdWZMWDdXV2lQdHVuN21Yc0VMUjAvTm5WNGMwb2d4Z2hYSEhLT1gzd3hRYmxaZzM0T2tnR24xQmFUUWJEc2M2UXVkVjQxZTc4dlg5VjZJaUg1b2xTdlJ6TWpZcFlHTy9ubG9HSGZ1ZTVzVU5nWkVaaTB3OVpLczhaK2I5cDlBV01vMU1WMzNDS0w5YzVZcTJvMlAvWDJ1NG1UUGN2bkVZWFgvc1o1d05HZkNjdXhTUnIwanUwOHlaK3ZrdWhwczByeHdxR1VEeVVxa2ZqeTRKajlzbTducTRIb1Bic1Nvc3h1N29FaEVTQnFuK28rY3lWUXVBWFFnTE9hZzB4YU1oUFVUcE91S3VKY2ZTS2NqU1dET0RxbzNJNjFhZGJKaE96eUI3aXRXZDNiaCs1bU9BdGpqMmcxbXdQcTBkZUhUT2UvODV0S0VtcVZGTk5DRkpIYzNrQ2tJaDBRUDNFMGVYMHkxSmxVSVVodWVoeUJBTzBtM05aMkNqbnMwVmlyS3ZsRnNqUGFNUUdsLzlHSXZjcTc3Si9lSDVPVk9pU0tDeGc0cnNiblB3a01IZERCbTRHZThaLzZJVnFhMzRia0xQNlBmRTdmQXVpWmx6eG9JL1FUMVEwMXhENEhmQ0ppUmQzeXVud2IrdnpSUEtkMU0xY1JKTVlSbWhxVFJsTVZtYkV1dmN2LzhYSXJzUXVMd1BSK3ViZU1rdSt6L21Zc09PaWs0TnY1SmhmaXJ3anpZL1JoaGdlM2c5Q3VuSlBrVjF0MVdVNTY0RHo4aU9mQjVPMlZqcnViU1orUW9kRmVkdnFFY3JSaXNzQkhDSnhKMERnL0RxTW1BSHhLQ1lLMGVNdWE3ODV1Y2hIR0xGTnk1UFlRQVFLQ0FRRUF3K2FKcXdkaXNqRmhieUJ1TTRMM05TRlFQRlhhMlVJWDRuM0FTTGh4WEVOWTZ3Q3BKSk5wbHFpcUdFZWlmSkwySEFLUEdxcWxyektUczBaQVpjOU9Ua0NITjNadXB5WEwxVFFBS2l4RmlxSlBHbkp6MGgwZnAzdXBZOVZJY3dudVBSdTNLQ1ExVTJvNVlMVjhnaG4vWkpnZ2E3OXBlWWpuclJYTGZSTzFwalJnRjdOTi85NHhyZnpTYnJQVXUwVlQrWFF0VDRpckhHU2dUWnlRc1FpUm5QUFB4RXY0S0xRYmJNMkJtb3JtRm9GTjYzVFFvcWVXbVo2ck81OXpBQSt1cmQrS3RIUUg2cjB1VEhleDFDcTduUmVUd0U3UmlMNzF4TXJXSVdYT21KTnpubFlxOWltdmczVnk1YThpOWplOFd4ejZuL1BnSzBEUW90ZlJXY1IwYVFLQ0FRRUE1RnI1TktJWkVuRTU2Mmd4eDlsaVFRd25LN3Z6RWJ6ODk3Y3hjQU56U1RtZG1FbTB5czROWHJiQ1NwM1BMR2RrZzN5TWRseExjaGo5TzJ2cnY4ZWhCTTRpYkJJM285REg5eVV5dzdvZDVQMUliNkVTOVZCZlhwN1dTT2tocm9VajhmVks4ZENZcTlwMmp0ZXVDSlBHcEpnbVFHb09UeTJvVi9nM09rSlY4TlVUSGwwKzl6YitOdDUzaTlUSWpoeUFUanVNSFphNnlyZDQ0UFlJV0FwY0FYQXF4eDdFWkJZclhkc1Z3bTlCdE9ER3VHYUhNWnBHc05pUU9HQ0hvVG1qbW9CYmFCU1dsMVBLYTBwNFJkVm9hWThtM0RFdXNwWmxaSnBnNk4xZGJUQVIxT0VXQ1FlWjlIMWhINnVUdi8rRHZTOG9TS0VrUzRvZHNJN2JsTVJ6QVFLQ0FRQU1DQWVpZW1Ta1h3WUY1aTcrZU9lbjJyRHIwN1lLSzlYOXNnMXlLZW5FYWRwM0xHWTIrZHE5UndTVFV5cjJqYXdSMGxKcHA5dGZKRE1RQ3B0LzVUaUE4OU9hSTJydVZ4THF1RFBlWXpPdUxRUEFzeERMOGIvMDhGSlo4RXB2emtkVWQzUkxRZFlJbG5pSnFQdkpuY0VpczNraVJQSThaWjBjOHo2NUl0SEFNRzFLWjFlK0JDNTI2aFVlZVdyeVNYSzcybGZDRDdtNmw2K0V0TDNxTVlXSDV5MTJkOWY0My83ak1zZm43dW5zcmVwVU1LdHpvZWxNN0FMR09hZTlkRGtkTXFKNUxMc2p2cFN1VzVlUFdVU0doR0V0cVdtVEJXOWdzN2hzK3F5eWtEUEVvTFFveEN5a1hUMCtRQUJjc05XZm51c0JrZC9OcUVCb0Qrc3FvVGNwQW9JQkFEa21rNHdhclkreUNyN2gydU9iZ2oycFh2eFJFNnB5MUJUaklscFlZcmdHMVd4UnRnK3p0aURvT0lRWUxzdDhMT25EZUJ2L1NWcUs2b1crb3NmaW5HZnBkeS80OXpmbWZzVlo1L1NZVmZjRGRPZUxOb1Z5MGd1S1VUTDZOZFhKdUk5THhxL3lkdU03ejhROE1uQXZHOTRCdmtFTXlmd0MvMGpVOUcxK1FLZi9pOE5qcnVpTU9OOWVtaWpDM2xiQ3gxSE5FV291V1IxM0FhZTdxNmJ0SU0yelZ1Rnl6OUFFeEdHKy9Sa21ZeGx6MEFoQ2tMOVhUeTNmWldqV3I5c240OHc5SjZOSzA4Mlh5T2RGUWdpb09uT0F3a2NGZ0J4dUMzNDhMTmphM2hEL29OYllabjFvQzUzbTZ6SFQ3U3gyTkhCYXB3aFdYQkVUeGc1MEVueVBGZ0VDZ2dFQkFLaWNZd0FVOWpWU282Qlk2d0tJNG9lbFRqNFRKWXZQRCtPeVNVOEx5MzRtNk95SXNNL1ltY1I1TmNlWGFiMmJBWU45QnZXK2NZeElvZGV0dmxzU29hckN6aVBXb1hidEM4aS9xcWdidXk4cjY1b2d6TzVzZDdmNllkb3kzTDZuZTFEY2ptcHdPOFV1WlNRNFBrMFhwY0d0RWRMaGdLYXJhc1JFWWxWcThaNHhTbTk3QzgzTEdKdGh5dUQxUUFwdS8vME9wMVdGWWpqUXBweVhuOW5VMTJRZTVlbDBkY2ZPREtTMDluVGdYUDhPUGtHeVlsNkwrdVA4d2V1eDJGUUpibGNhdm9YSlBtUkpiajlNVXFORWtjaVIyR3QvWkJ3NzBPRHlkb0dIb1BWa0VQUHdSclY3dkxKUmdHcjBzWGlKOTVRSEVNbnU4enZySm9tdndBSy9DcTg9CnNlcnZlcjoKICB2MToKICAgIGlzc3VlcjogaHR0cHM6Ly9hdXRoLmZhbGtvd3NraS5pbwogICAgYWRtaW5zOgogICAgICAtIGlkOiBhZG1pbgogICAgICAgIGhhc2g6ICQyYSQxMCRnRE5nRXVkQmUud0pkN2NadEJxOXR1QUZwSHZYdXplcnZ5bG01OTNWWTdQdDRPOUkuekpFbQogICAgICAgICAgICAgICMgTUNaeEwkWTViZXlwQVdqPEpRRU5mdEBQX0RYVnVoIyxdMDJycTFId2Q2OW1GZyhSfDdjaSZUbGFvQlU4azNzNAogICAgc2VydmljZXM6CiAgICAgIC0gaWQ6IGUxNjAyZTE4NWNiYTJhOTBkOGJiY2ZjM2YzYzU1MzBjCiAgICAgICAgbmFtZTogZGV2ZWxvcGVyCiAgICAgICAgaGFzaDogJDJhJDEwJGJpbVVJNU0vcGtSWWdJQzNVSHpneS5jWmpGZXROdmd0M3ZHLlNQVlFSc3FVOE9GYjhWOVVHCiAgICAgICAgICAgICAgIyB1Qz9NeHdLTytyMUAwUlhbcThWNXM0Rnwzb1EpeVo3VFlEbFVIbUlmZU5uOUUmU2NMMlBre2ckcGldejZiQnRhCiAgICAgICAgICAgICAgIyBQRTcrMU1kRkxQa3diM0JDVEVZeGVzQ3NkOTZiYiszY2ZaYk9iYmlqV09zUTM5SHR2bFFFOVR1cHREcnVyV09lRDRnamh4elAxZUdFRjdBOENFOWRkTDFnVWV1bHZXWUoxNk1Lb2crUm9zYnN4azNkemU1ajF5eGhSaU16aEg0YkllNE12Q0hkaTJOUElSYlQ3cVFjakJIcjA0S3VIak8ycVl5YTM5OGtNdUZxNVhlenBsMXV2djdpZGNwUFFtZ1Q2dkt6RkgxNGhWRlIxUjFTMUFCQ2U3eDJGd3hsNnhEamFldG9KN3ZycFZ3d2JxT0xsNzlMNVU5OFFHeUFIVkUxa3hFa3Vyc1BRQkdhN3JiM3MwTEhBUUNKT3hTNmRhZVY2WGtiZC95NHJDMkwrNjV4ZkIyRkFNWnR2ZytiWCtUcjZTNEV5UXlRdDBHZkp2WC84Y055NlROMjFVRzczRk5FazNUWUl6NDZKQWhSYUdrMkF0bjQrQU8zNVlwejc1b3ZaZ2huOHNuQWtTU05qZVpNblRGS2YwdU5JUzZXL3hVTFpjYVpueFlLWXd3anhzVHdHc00vSDk3bjJZcWJhRU96RzRmVTY5bUpzejBLd0EvMlRFMWFxaGI1SHBmMkdiSlZ4b043QWtOcDZrUm1tdWZNc3NabHVYQzVYZCtiS1NyTnNLMnl6eEFnUHJWN1gveElmcWVKWjY1M1ZwNkhldk43RzQxalF1WEJYY2duNG5udWJuZitmLzNDeXZCcEljd205T29WRkZnYjBDNjBuWkZNbVNleC95YzZFd2FSUCs5RUVFU3p0Q3pYK1c5a04wZk5IQ25xMityWXNWZmM0d1pWbFFxMGFSZ3RsMWs5dW1HSTFpa2pHd1dhSjh1d214U09KSFB5ZzZ4Rm1Ebz0KICAgICAgICBkdXJhdGlvbjogMjRoCiAgICAgIC0gaWQ6IDdlOGMyNDM3OTkzMGQxMDdiMmQyODFhYTIzMjQ3MDkyCiAgICAgICAgbmFtZToga29uZmlnCiAgICAgICAgaGFzaDogJDJhJDEwJEhzSHFLZmlFdzh4U2F2Yk4uRUF0Vi5DcXMuMTdtLmh5N3ZWaktreUZVN0ROcnRlRGFETEtpCiAgICAgICAgICAgICAgIyBLdDhHUWtyLzYxcSpiUjp5Rkk3MlhuYTBATUN2cCRPXTM5bSlaSmZ4Tjw0fVNEc0VUSGheV2U1UGdCaW9kVWxjCiAgICAgICAgICAgICAgIyBpRXpIalJwRDgvc0VNekNGUEEwSnFVL0l0YUJQWndZbHNhNlc1M3ZIeTZ5eTNNaURrYmJoRGFwSGxqUjVJKzNNenBoN2pUcXJsQk1BREQxVGRKUFZBd010VWdmV013b0lReXBGUHFGWVcyaVh2VHRDejFxNHdsb1RKcCtQVG9JSS9RMzdWT3lYMjZTTitwT3NWaDJRYXhFZzJlT0lHSUF4Y2k0bEJKNE1uWnZyYllzRHRLV05NMWZtMEpxUFl0UjZmcnB0OVl5eFA0WDFkUUc5NTNlWUZ4TE1sZStTRWkrRWg1TlVlSXBZVlRuSFc2L1VVdGtlTnJKN0dabXo1UkhDaW4ySTVjY2QzRXV1K0NuY0M4Nyt6ZW5pU1dRZE00U3gxbXJ4SlFURjQvYkd4ZjYyOXdwSnpuNWFoMW9DMU5qd3Z3VWpkRlFLV0lVM21NbERRVjdxQ3JvTFBUbzdORkU2THBIT3huYTVQeDhzNnFMV25MR1FER0NZSzZZVUxGcXh0UWZscERBR0dwTEg0Wlh3THFwaXNrT1p3MjJ1eGdvUmxRTHBoSVFMZnhhNUkxUGRrL1RMaFNRYWRhY1k4OE95bTg4bWZnSS94VFJUVzY5Q2huYlRMbnd1NjVPV3F6SzhTZzdqa1YrYmVNWkw0OUIxMDA4QkdhdC83dHJ1QzFmWUpmUEdKRWV0TmlPUzRvNEkrMDVxV2VEcyszWGF5SVRmODczajF5aGo4dVpVTG1CcUVZaERTcnBKYm5zd0Rwc3k5R3dHM1dyRS9sa3dNN3lwNDNvWjM1YmNNSm5leU1rVGhDUmlnTWdpUEhJUzQwdUpHUXBYenNXRVZyQkdqbEFsMVBvQllYeGF4RDV3cnF2dWVtUk9HZHN3S3hRNlRoNW5mMVk1TFhHcHhlRT0KICAgICAgICBkdXJhdGlvbjogMjRoCnRlbGVtZXRyeToKICBsb2dnZXI6CiAgICBsZXZlbDogaW5mbwogIHRyYWNlcjoKICAgIGhvc3Q6IGxvY2FsaG9zdDo0MzE4CiAgICBzZWN1cmU6IGZhbHNlCnRva2VuOgogIGtpbmQ6IGF1dGgKdHJhbnNwb3J0OgogIGh0dHA6CiAgICBwb3J0OiA1MDAwCiAgICB1c2VyX2FnZW50OiAiQXV0aC1zZXJ2ZXIvMS4wIGh0dHAvMS4wIgogICAgcmV0cnk6CiAgICAgIHRpbWVvdXQ6IDEwcwogICAgICBhdHRlbXB0czogMwogIGdycGM6CiAgICBlbmFibGVkOiB0cnVlCiAgICBwb3J0OiA1MDAxCiAgICB1c2VyX2FnZW50OiAiQXV0aC1zZXJ2ZXIvMS4wIGdycGMvMS4wIgogICAgcmV0cnk6CiAgICAgIHRpbWVvdXQ6IDEwcwogICAgICBhdHRlbXB0czogMwo=
    working_directory: ~/konfig
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - run: dockerize -wait tcp://localhost:8200 -wait tcp://localhost:4566 -wait tcp://localhost:5001 -timeout 1m
      - run: make setup
      - run: make feature=features tags=@http features
      - store_artifacts:
          path: test/reports
      - run: make -C test leave-coverage
      - persist_to_workspace:
          root: test
          paths:
            - reports
    resource_class: large
  features-coveralls:
    docker:
      - image: alexfalkowski/go:1.22-ruby
    working_directory: ~/konfig
    steps:
      - checkout
      - attach_workspace:
          at: test
      - run: git submodule sync
      - run: git submodule update --init
      - run: make goveralls
    resource_class: large
  release:
    docker:
      - image: alexfalkowski/release:3.1
    working_directory: ~/konfig
    steps:
      - checkout
      - run: release
    resource_class: large
  push-docker:
    docker:
      - image: alexfalkowski/go:1.22-ruby
    working_directory: ~/konfig
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - setup_remote_docker
      - run:
          name: make login
          command: echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      - run: make push-docker
    resource_class: large

workflows:
  konfig:
    jobs:
      - build-service
      - build-docker
      - features-grpc
      - features-http
      - features-coveralls:
          requires:
            - features-grpc
            - features-http
      - release:
          context: gh
          requires:
            - build-service
            - build-docker
            - features-coveralls
          filters:
            branches:
              only: master
      - push-docker:
          context: docker
          requires:
            - release
          filters:
            branches:
              only: master
