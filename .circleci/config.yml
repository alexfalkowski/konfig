version: 2.1

jobs:
  build-service:
    docker:
      - image: alexfalkowski/go:1.22-ruby
    working_directory: ~/konfig
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - restore_cache:
          name: restore go deps
          keys:
            - konfig-build-service-go-cache-{{ checksum "go.sum" }}
            - konfig-build-service-go-cache-
      - restore_cache:
          name: restore ruby deps
          keys:
            - konfig-build-service-ruby-cache-{{ checksum "test/Gemfile.lock" }}
            - konfig-build-service-ruby-cache-
      - run: make dep
      - save_cache:
          name: save go deps
          key: konfig-build-service-go-cache-{{ checksum "go.sum" }}
          paths:
            - /home/circleci/go/pkg/mod
      - save_cache:
          name: save ruby deps
          key: konfig-build-service-ruby-cache-{{ checksum "test/Gemfile.lock" }}
          paths:
            - test/vendor
      - restore_cache:
          name: restore go build cache
          keys:
            - konfig-build-service-go-build-cache-{{ checksum "go.sum" }}
            - konfig-build-service-go-build-cache-
      - run: make lint
      - run: make proto-breaking
      - run: make sec
      - save_cache:
          name: save go build cache
          key: konfig-build-service-go-build-cache-{{ checksum "go.sum" }}
          paths:
            - /home/circleci/.cache/go-build
      - run: make outdated-dep
    resource_class: large
  build-docker:
    docker:
      - image: alexfalkowski/go:1.22-ruby
    working_directory: ~/konfig
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - setup_remote_docker
      - run: make build-docker
      - run: make trivy
    resource_class: large
  features-grpc:
    docker:
      - image: alexfalkowski/go:1.22-ruby
      - image: localstack/localstack:3.4
        environment:
          SERVICES: s3,ssm
      - image: hashicorp/vault:1.16
        environment:
          VAULT_DEV_ROOT_TOKEN_ID: vault-plaintext-root-token
      - image: alexfalkowski/auth:latest
        command: server
        environment:
          AUTH_IN_CONFIG_FILE: yaml:CONFIG
          CONFIG: Y2FjaGU6CiAgcmlzdHJldHRvOgogICAgbnVtX2NvdW50ZXJzOiAxMDAwMDAwMAogICAgbWF4X2Nvc3Q6IDEwMDAwMDAwMAogICAgYnVmZmVyX2l0ZW1zOiA2NApjYXNiaW46CiAgbW9kZWw6IHwKICAgIFtyZXF1ZXN0X2RlZmluaXRpb25dCiAgICByID0gc3ViLCBvYmosIGFjdAoKICAgIFtwb2xpY3lfZGVmaW5pdGlvbl0KICAgIHAgPSBzdWIsIG9iaiwgYWN0CgogICAgW3BvbGljeV9lZmZlY3RdCiAgICBlID0gc29tZSh3aGVyZSAocC5lZnQgPT0gYWxsb3cpKQoKICAgIFttYXRjaGVyc10KICAgIG0gPSByLnN1YiA9PSBwLnN1YiAmJiByLm9iaiA9PSBwLm9iaiAmJiByLmFjdCA9PSBwLmFjdAogIHBvbGljeTogfAogICAgcCwgZGV2ZWxvcGVyLCBrb25maWcsIGdldC1jb25maWcKY2xpZW50OgogIHYxOgogICAgaG9zdDogbG9jYWxob3N0OjUwMDEKICAgIHRpbWVvdXQ6IDFzCiAgICB1c2VyX2FnZW50OiAiQXV0aC1jbGllbnQvMS4wIGdycGMvMS4wIgogICAgcmV0cnk6CiAgICAgIHRpbWVvdXQ6IDEwcwogICAgICBhdHRlbXB0czogMwpjcnlwdG86CiAgZWQyNTUxOToKICAgIHB1YmxpYzogSVJ2cUFvUTRZV3FxVEwySVVSdWNQYkpIVlNMdzAvSVdMQ3p2cmlIbGhmYz0KICAgIHByaXZhdGU6IEV4TFBGSWlPTEI2ZmxsQzBMeXNlVXlpd0V5dTQwM2ordmsyR0QxdjJMS1VoRytvQ2hEaGhhcXBNdlloUkc1dzlza2RWSXZEVDhoWXNMTyt1SWVXRjl3PT0KICByc2E6CiAgICBwdWJsaWM6IE1JSUNDZ0tDQWdFQXJyN3dYRHQ2NHhHbXBPVXRlL0NpV28ybGsxM3NheElONStwMmJsYXR3emZVbVdsRVMwMVdYaDk1cmI3ZXpyKzlhNlJWRW9KOVY2dUVPRDhxTGVvSEJZSXpMb0I3d3J0TkFsT1hFWTRuaXF6Rm9WVXNpdTZSc3RmNDUrdXVUMUpnMjd0bjVwUlBFNUxRR2dMZlJ3K3JObUI5cHJVL3IrR29qazlRRzI0Y05mLzBNMHZuT1o0dDJML2ZTUW83WFhkM1U3QXNHNHIxYWVuR3lvUHdlVmdNWXkvOC84SzlaWUNMd3JjSUtZcU56T1grSkZBN2FHaDlOc3FRWU1TSUpoYWZLbFBIbHBGaWNVa3JjUGtmUFRiWU1ZYXU4MmZMYWh0Tjd4MC8yK21jdy85RzczUzRkNVJoNkNGZ3FVZ096aThGVXZmYXEvZTQyQU1CZkdQdXA0ODFxQ2UyS3hzRS83b0I1ZURSQU91c1pDbzgzeDl1VjVCakxva3FUWGw5V2NtYzdXOTBKM3VuTEVPK21yR1VaaENzd3p1RVJnZmc3YTJXMjV4NFBBZjI5aGU2eGpFWUNoaVYrRjdXUkhVUThGV2pWQUJuSWI2VVNNS1crYUI3a2xCejVmQ2VhRHRiWFRFR3YwMVhoOXhiNm0rNC9SbW1iZlZicjl0aHc5UWlWWTVtSkEwRnFGMnI0VDZ6TVJIa3ZtVCtUdDVBTUhuRmR6SldSWFRBVFZDSmZ4Q3FJTUN4OTRpZnE3YzhTTnF0OGo3MnhqanNMbGFDNVBFRUNKL2RrSnJ1aFJTWnM4YUlTZXZCSWR2SmVWaC9NTWRhaml5UW92VmpIVzhXUkh3Z0ZyZjJSbDB0MGczbHNHcUFHUTJxenk2c05jMjcrdWw5YjJZbzdKWUVyVzV6bjJrQ0F3RUFBUT09CiAgICBwcml2YXRlOiBNSUlKS0FJQkFBS0NBZ0VBcnI3d1hEdDY0eEdtcE9VdGUvQ2lXbzJsazEzc2F4SU41K3AyYmxhdHd6ZlVtV2xFUzAxV1hoOTVyYjdlenIrOWE2UlZFb0o5VjZ1RU9EOHFMZW9IQllJekxvQjd3cnROQWxPWEVZNG5pcXpGb1ZVc2l1NlJzdGY0NSt1dVQxSmcyN3RuNXBSUEU1TFFHZ0xmUncrck5tQjlwclUvcitHb2prOVFHMjRjTmYvME0wdm5PWjR0MkwvZlNRbzdYWGQzVTdBc0c0cjFhZW5HeW9Qd2VWZ01ZeS84LzhLOVpZQ0x3cmNJS1lxTnpPWCtKRkE3YUdoOU5zcVFZTVNJSmhhZktsUEhscEZpY1VrcmNQa2ZQVGJZTVlhdTgyZkxhaHRON3gwLzIrbWN3LzlHNzNTNGQ1Umg2Q0ZncVVnT3ppOEZVdmZhcS9lNDJBTUJmR1B1cDQ4MXFDZTJLeHNFLzdvQjVlRFJBT3VzWkNvODN4OXVWNUJqTG9rcVRYbDlXY21jN1c5MEozdW5MRU8rbXJHVVpoQ3N3enVFUmdmZzdhMlcyNXg0UEFmMjloZTZ4akVZQ2hpVitGN1dSSFVROEZXalZBQm5JYjZVU01LVythQjdrbEJ6NWZDZWFEdGJYVEVHdjAxWGg5eGI2bSs0L1JtbWJmVmJyOXRodzlRaVZZNW1KQTBGcUYycjRUNnpNUkhrdm1UK1R0NUFNSG5GZHpKV1JYVEFUVkNKZnhDcUlNQ3g5NGlmcTdjOFNOcXQ4ajcyeGpqc0xsYUM1UEVFQ0ovZGtKcnVoUlNaczhhSVNldkJJZHZKZVZoL01NZGFqaXlRb3ZWakhXOFdSSHdnRnJmMlJsMHQwZzNsc0dxQUdRMnF6eTZzTmMyNyt1bDliMllvN0pZRXJXNXpuMmtDQXdFQUFRS0NBZ0J6VDAvd3JOZEVhMnRadUZreFJmTDhhaWZ1ZkxYN1dXaVB0dW43bVhzRUxSMC9OblY0YzBvZ3hnaFhISEtPWDN3eFFibFpnMzRPa2dHbjFCYVRRYkRzYzZRdWRWNDFlNzh2WDlWNklpSDVvbFN2UnpNallwWUdPL25sb0dIZnVlNXNVTmdaRVppMHc5WktzOForYjlwOUFXTW8xTVYzM0NLTDljNVlxMm8yUC9YMnU0bVRQY3ZuRVlYWC9zWjV3TkdmQ2N1eFNScjBqdTA4eVordmt1aHBzMHJ4d3FHVUR5VXFrZmp5NEpqOXNtN25xNEhvUGJzU29zeHU3b0VoRVNCcW4rbytjeVZRdUFYUWdMT2FnMHhhTWhQVVRwT3VLdUpjZlNLY2pTV0RPRHFvM0k2MWFkYkpoT3p5QjdpdFdkM2JoKzVtT0F0amoyZzFtd1BxMGRlSFRPZS84NXRLRW1xVkZOTkNGSkhjM2tDa0loMFFQM0UwZVgweTFKbFVJVWh1ZWh5QkFPMG0zTloyQ2puczBWaXJLdmxGc2pQYU1RR2wvOUdJdmNxNzdKL2VINU9WT2lTS0N4ZzRyc2JuUHdrTUhkREJtNEdlOFovNklWcWEzNGJrTFA2UGZFN2ZBdWlabHp4b0kvUVQxUTAxeEQ0SGZDSmlSZDN5dW53Yit2elJQS2QxTTFjUkpNWVJtaHFUUmxNVm1iRXV2Y3YvOFhJcnNRdUx3UFIrdWJlTWt1K3ovbVlzT09pazROdjVKaGZpcndqelkvUmhoZ2UzZzlDdW5KUGtWMXQxV1U1NjREejhpT2ZCNU8yVmpydWJTWitRb2RGZWR2cUVjclJpc3NCSENKeEowRGcvRHFNbUFIeEtDWUswZU11YTc4NXVjaEhHTEZOeTVQWVFBUUtDQVFFQXcrYUpxd2Rpc2pGaGJ5QnVNNEwzTlNGUVBGWGEyVUlYNG4zQVNMaHhYRU5ZNndDcEpKTnBscWlxR0VlaWZKTDJIQUtQR3FxbHJ6S1RzMFpBWmM5T1RrQ0hOM1p1cHlYTDFUUUFLaXhGaXFKUEduSnowaDBmcDN1cFk5Vkljd251UFJ1M0tDUTFVMm81WUxWOGdobi9aSmdnYTc5cGVZam5yUlhMZlJPMXBqUmdGN05OLzk0eHJmelNiclBVdTBWVCtYUXRUNGlySEdTZ1RaeVFzUWlSblBQUHhFdjRLTFFiYk0yQm1vcm1Gb0ZONjNUUW9xZVdtWjZyTzU5ekFBK3VyZCtLdEhRSDZyMHVUSGV4MUNxN25SZVR3RTdSaUw3MXhNcldJV1hPbUpOem5sWXE5aW12ZzNWeTVhOGk5amU4V3h6Nm4vUGdLMERRb3RmUldjUjBhUUtDQVFFQTVGcjVOS0laRW5FNTYyZ3h4OWxpUVF3bks3dnpFYno4OTdjeGNBTnpTVG1kbUVtMHlzNE5YcmJDU3AzUExHZGtnM3lNZGx4TGNoajlPMnZydjhlaEJNNGliQkkzbzlESDl5VXl3N29kNVAxSWI2RVM5VkJmWHA3V1NPa2hyb1VqOGZWSzhkQ1lxOXAyanRldUNKUEdwSmdtUUdvT1R5Mm9WL2czT2tKVjhOVVRIbDArOXpiK050NTNpOVRJamh5QVRqdU1IWmE2eXJkNDRQWUlXQXBjQVhBcXh4N0VaQllyWGRzVndtOUJ0T0RHdUdhSE1acEdzTmlRT0dDSG9UbWptb0JiYUJTV2wxUEthMHA0UmRWb2FZOG0zREV1c3BabFpKcGc2TjFkYlRBUjFPRVdDUWVaOUgxaEg2dVR2LytEdlM4b1NLRWtTNG9kc0k3YmxNUnpBUUtDQVFBTUNBZWllbVNrWHdZRjVpNytlT2VuMnJEcjA3WUtLOVg5c2cxeUtlbkVhZHAzTEdZMitkcTlSd1NUVXlyMmphd1IwbEpwcDl0ZkpETVFDcHQvNVRpQTg5T2FJMnJ1VnhMcXVEUGVZek91TFFQQXN4REw4Yi8wOEZKWjhFcHZ6a2RVZDNSTFFkWUlsbmlKcVB2Sm5jRWlzM2tpUlBJOFpaMGM4ejY1SXRIQU1HMUtaMWUrQkM1MjZoVWVlV3J5U1hLNzJsZkNEN202bDYrRXRMM3FNWVdINXkxMmQ5ZjQzLzdqTXNmbjd1bnNyZXBVTUt0em9lbE03QUxHT2FlOWREa2RNcUo1TExzanZwU3VXNWVQV1VTR2hHRXRxV21UQlc5Z3M3aHMrcXl5a0RQRW9MUW94Q3lrWFQwK1FBQmNzTldmbnVzQmtkL05xRUJvRCtzcW9UY3BBb0lCQURrbWs0d2FyWSt5Q3I3aDJ1T2JnajJwWHZ4UkU2cHkxQlRqSWxwWVlyZ0cxV3hSdGcrenRpRG9PSVFZTHN0OExPbkRlQnYvU1ZxSzZvVytvc2ZpbkdmcGR5LzQ5emZtZnNWWjUvU1lWZmNEZE9lTE5vVnkwZ3VLVVRMNk5kWEp1STlMeHEveWR1TTd6OFE4TW5Bdkc5NEJ2a0VNeWZ3Qy8walU5RzErUUtmL2k4TmpydWlNT045ZW1pakMzbGJDeDFITkVXb3VXUjEzQWFlN3E2YnRJTTJ6VnVGeXo5QUV4R0crL1JrbVl4bHowQWhDa0w5WFR5M2ZaV2pXcjlzbjQ4dzlKNk5LMDgyWHlPZEZRZ2lvT25PQXdrY0ZnQnh1QzM0OExOamEzaEQvb05iWVpuMW9DNTNtNnpIVDdTeDJOSEJhcHdoV1hCRVR4ZzUwRW55UEZnRUNnZ0VCQUtpY1l3QVU5alZTbzZCWTZ3S0k0b2VsVGo0VEpZdlBEK095U1U4THkzNG02T3lJc00vWW1jUjVOY2VYYWIyYkFZTjlCdlcrY1l4SW9kZXR2bHNTb2FyQ3ppUFdvWGJ0QzhpL3FxZ2J1eThyNjVvZ3pPNXNkN2Y2WWRveTNMNm5lMURjam1wd084VXVaU1E0UGswWHBjR3RFZExoZ0thcmFzUkVZbFZxOFo0eFNtOTdDODNMR0p0aHl1RDFRQXB1Ly8wT3AxV0ZZampRcHB5WG45blUxMlFlNWVsMGRjZk9ES1MwOW5UZ1hQOE9Qa0d5WWw2TCt1UDh3ZXV4MkZRSmJsY2F2b1hKUG1SSmJqOU1VcU5Fa2NpUjJHdC9aQnc3ME9EeWRvR0hvUFZrRVBQd1JyVjd2TEpSZ0dyMHNYaUo5NVFIRU1udTh6dnJKb212d0FLL0NxOD0KZW52aXJvbm1lbnQ6IHByb2R1Y3Rpb24KaGVhbHRoOgogIGR1cmF0aW9uOiAxcwogIHRpbWVvdXQ6IDFzCnNlcnZlcjoKICB2MToKICAgIGlzc3VlcjogaHR0cHM6Ly9hdXRoLmZhbGtvd3NraS5pbwogICAgYWRtaW5zOgogICAgICAtIGlkOiBhZG1pbgogICAgICAgIGhhc2g6ICRhcmdvbjJpZCR2PTE5JG09NjU1MzYsdD0zLHA9NCRUbzdJT3lRZWswRXphL1YrY0dFNWlBJENzYXRnQTNzU012UE04WUpZNTNTWGFSWi9DbHlGTEFmRGJXclFXdWZFSlEKICAgICAgICAgICAgICAjIG97NndKVEVTdkF5L1o4YWxrQzBdYmpzUWQyKn56Zn1ER3A9KWVMdFhnI25WNTFJUnJQOTc0WTNtS0J4cSVPV2kKICAgIHNlcnZpY2VzOgogICAgICAtIGlkOiBlMTYwMmUxODVjYmEyYTkwZDhiYmNmYzNmM2M1NTMwYwogICAgICAgIG5hbWU6IGRldmVsb3BlcgogICAgICAgIGhhc2g6ICRhcmdvbjJpZCR2PTE5JG09NjU1MzYsdD0zLHA9NCRLK1FtTXJxZXhidG5XWUdoU3doN0JRJGw4dk1jZ2Y4eUFXUlgxV041RGVQTXZkMVI3Q2o3U0NSdGFnZUFSczU0aXcKICAgICAgICAgICAgICAjICRWekxfLUhkUDNZN29FKDY0P2pmQElyYXV8QkohPGVpMCk1MVdjRGhuUWtaQTJOdFhNVDh5T2JHVXNndktSbDkKICAgICAgICAgICAgICAjIGppcHRHZnBwUjVVOXVWSFNEUERNbG5vT2ZUeXNVZnJ1dUVuZ3ZKRG5vL0xnRHQzWWlZVCsvV01CUnIvVjkxZHNYQ2NTWWZ1dDZwZ1VXaDVldkJyRDRtWEdvQ2M4enJsSU0rZmxsZ2NHUE51R1NZazIxUTlDM0pLYUJtNjE3dU9WM25JdDFrSlQvVktySkdUZnFPZWlSY1BnMysxMVVyajQvUjhOZnl3WkNoQVF0ZWtvWktqR2VCNFM5ZytvVE5EeE9rU1dmWXlZM2ZpR2h4UWY0UjRLcFhhSkZQNGpFV05vVE5zbHdUTVNiRkFkRitqMitOZTNyQTFqU1VKdmtVWnhqUDBzblVrYlNETEIvQmlya1pCVURIT25WUE9wZExaY2tHZkRwVTNOZS8rWkpaQU9BRUNrREJ1ek12K29PcHRSZ0svQVN4VUVzNVJXQzlBek9qRkoyVmRvVUozeXFwcXUwKzNybjNxQXI4WUNVd1VEWUxRUzU3VEg5RVNhdy9OTFc5UWpxbitrdTh5OXpxbWZxUlJ4NC9seGttVi9nVHhKdVpIRTJBSmRpcmt6anA2UUtUdTNEVENuM3FTcWxXVm5tRTZabzhzSDNZQ0JQem9qZjU3RGVaTGpQMmpnVnpzSXFUdFJUN2QvcVhINys3QjFmNGJCOU1oVWhiSU16SERxOTdab214K0pEcm9iSzViQXROSFlaVjRjSnVrV3dselpERVlMTkdVYnV1S1hpRXI4QXVYaWx3TmhpNHZVRFl6cS9yL1VSb2oyM2pNUkpIL2NiMktxMktDSFBzMXUzNjJUbUFHUk4xL3liUVpkdXdTUUhEbXhhV1RJYzBsQTBaQkxXdmJGcUxuTlBGNWx5M3N3bjVFREJkWCtaZTNzTXRoeldTUGNnVHMwdG9nPQogICAgICAgIGR1cmF0aW9uOiAyNGgKICAgICAgLSBpZDogN2U4YzI0Mzc5OTMwZDEwN2IyZDI4MWFhMjMyNDcwOTIKICAgICAgICBuYW1lOiBrb25maWcKICAgICAgICBoYXNoOiAkYXJnb24yaWQkdj0xOSRtPTY1NTM2LHQ9MyxwPTQkd25QVUZObmpRL0REbkZDYjRJbGlqdyQzN25NM2NtRVEzYU96N2w1bDF1M1ZrZHR3cjRCVjg4OXJ2NTJOdVhURTJnCiAgICAgICAgICAgICAgIyAwSmxqQHZOcEJvPFFMQ21aRkh4ZFRWXiFlR1UtMmk2QSVxNy5me3k5UGhPTUkzd2IxYX0/bms1NDhnS3VydFJFCiAgICAgICAgICAgICAgIyBpdEN5YVAxa3BYQVFZRTJ1RC94OTZmYThqd0lHazhveHF1WVlHNHVvMEEva3M0RnpuT0p6ZFNmSFFJalNObkhjOFFzUURyMzQwMERuRUlzUWx1MCtQVnJDdksrSGNiaENtV1RWOTU2UTRpcWtpNmZMQ1pSV0hBSWdtYmxFZVBueWw1NE9yZGs3M3JuYjdmYnZieHZlTDFmeTk1bFVKdXR0Z1RzUG1MUExLWkNiK0hOaFU0YnFSZERmWVBLY21FL3graFJJalQ4UlJUZ3JRZ041dEhrdjY3RlNZdkM5SE42ZmN3bjdOSmVRbG5FaWFzSkFjcGpnZEVJYXo2bVJmdWZQSUd0RlVXajBwb2JIcDZCMkEyZVY2Q0NFaFhKZ1EzaVVGWTZzdGg3bHYvMHk1aVVhSnBzQk1EbWcyZERWalBKYk1QMjJGanBwdEl4SkxoNjI0TCtCMlRKeFFMMStlNmVQR05zR1poWjQ4R3MwdnM4eWJ5WHpwa1J4Z0kvRnM0MVN2bUFmSituUHY5V2lVeEViUU5YRVZNK0NYejkzdnJzWDZ3cGkxRndtaGVGdkd5ajJnRGJFTzFPV3V3V0FHTlZSYjJZbExyTmpNR0U1U2hUaHlJV2R2REJPOTZTR1hRdm1BRkNxRjE5OXZzZ2U4ZUFtZEsyUEJBTWlIMTkyc2lobzBzT1Y4c1dEblBIL3A0bmUzaS9lamZhWUhNbzFNVEpLanFnTG5uY25ndDRROS9tV0xqcDdoY293NXNXOCtaTlFvNFJ5TGJRM05FbmRjNi9OVkFQM2VLdVZYbmxrUUp4dm1ZVlMyVUtaeTJUT3RCTlpnMjhKU0M3NkhQOHNmOWFPUXE1VXN1c1IyMnJrZ0YrU0tNcUN4ZG5mSlVqZTFBbG1GY2gyYUNpaGU5QT0KICAgICAgICBkdXJhdGlvbjogMjRoCnRlbGVtZXRyeToKICBsb2dnZXI6CiAgICBsZXZlbDogaW5mbwogIG1ldHJpY3M6CiAgICBraW5kOiBwcm9tZXRoZXVzCiAgdHJhY2VyOgogICAga2luZDogb3RscAogICAgaG9zdDogaHR0cDovL2xvY2FsaG9zdDo0MzE4L3YxL3RyYWNlcwp0b2tlbjoKICBraW5kOiBhdXRoCnRyYW5zcG9ydDoKICBodHRwOgogICAgcG9ydDogNTAwMAogICAgdXNlcl9hZ2VudDogIkF1dGgtc2VydmVyLzEuMCBodHRwLzEuMCIKICAgIHJldHJ5OgogICAgICB0aW1lb3V0OiAxMHMKICAgICAgYXR0ZW1wdHM6IDMKICBncnBjOgogICAgcG9ydDogNTAwMQogICAgdXNlcl9hZ2VudDogIkF1dGgtc2VydmVyLzEuMCBncnBjLzEuMCIKICAgIHJldHJ5OgogICAgICB0aW1lb3V0OiAxMHMKICAgICAgYXR0ZW1wdHM6IDMK
      - image: grafana/mimir:latest
        command: -server.http-listen-port=9009 -auth.multitenancy-enabled=false -ingester.ring.replication-factor=1
    working_directory: ~/konfig
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - run: dockerize -wait tcp://localhost:8200 -wait tcp://localhost:4566 -wait tcp://localhost:5001 -wait tcp://localhost:9009 -timeout 1m
      - restore_cache:
          name: restore go deps
          keys:
            - konfig-features-grpc-go-cache-{{ checksum "go.sum" }}
            - konfig-features-grpc-go-cache-
      - restore_cache:
          name: restore ruby deps
          keys:
            - konfig-features-grpc-ruby-cache-{{ checksum "test/Gemfile.lock" }}
            - konfig-features-grpc-ruby-cache-
      - run: make dep
      - save_cache:
          name: save go deps
          key: konfig-features-grpc-go-cache-{{ checksum "go.sum" }}
          paths:
            - /home/circleci/go/pkg/mod
      - save_cache:
          name: save ruby deps
          key: konfig-features-grpc-ruby-cache-{{ checksum "test/Gemfile.lock" }}
          paths:
            - test/vendor
      - restore_cache:
          name: restore go build cache
          keys:
            - konfig-features-grpc-go-build-cache-{{ checksum "go.sum" }}
            - konfig-features-grpc-go-build-cache-
      - run: make features-grpc
      - save_cache:
          name: save go build cache
          key: konfig-features-grpc-go-build-cache-{{ checksum "go.sum" }}
          paths:
            - /home/circleci/.cache/go-build
      - store_test_results:
          path: test/reports
      - store_artifacts:
          path: test/reports
      - run: make -C test leave-coverage
      - persist_to_workspace:
          root: test
          paths:
            - reports
    resource_class: large
  features-http:
    docker:
      - image: alexfalkowski/go:1.22-ruby
      - image: localstack/localstack:3.4
        environment:
          SERVICES: s3,ssm
      - image: hashicorp/vault:1.16
        environment:
          VAULT_DEV_ROOT_TOKEN_ID: vault-plaintext-root-token
      - image: alexfalkowski/auth:latest
        command: server
        environment:
          AUTH_IN_CONFIG_FILE: yaml:CONFIG
          CONFIG: Y2FjaGU6CiAgcmlzdHJldHRvOgogICAgbnVtX2NvdW50ZXJzOiAxMDAwMDAwMAogICAgbWF4X2Nvc3Q6IDEwMDAwMDAwMAogICAgYnVmZmVyX2l0ZW1zOiA2NApjYXNiaW46CiAgbW9kZWw6IHwKICAgIFtyZXF1ZXN0X2RlZmluaXRpb25dCiAgICByID0gc3ViLCBvYmosIGFjdAoKICAgIFtwb2xpY3lfZGVmaW5pdGlvbl0KICAgIHAgPSBzdWIsIG9iaiwgYWN0CgogICAgW3BvbGljeV9lZmZlY3RdCiAgICBlID0gc29tZSh3aGVyZSAocC5lZnQgPT0gYWxsb3cpKQoKICAgIFttYXRjaGVyc10KICAgIG0gPSByLnN1YiA9PSBwLnN1YiAmJiByLm9iaiA9PSBwLm9iaiAmJiByLmFjdCA9PSBwLmFjdAogIHBvbGljeTogfAogICAgcCwgZGV2ZWxvcGVyLCBrb25maWcsIGdldC1jb25maWcKY2xpZW50OgogIHYxOgogICAgaG9zdDogbG9jYWxob3N0OjUwMDEKICAgIHRpbWVvdXQ6IDFzCiAgICB1c2VyX2FnZW50OiAiQXV0aC1jbGllbnQvMS4wIGdycGMvMS4wIgogICAgcmV0cnk6CiAgICAgIHRpbWVvdXQ6IDEwcwogICAgICBhdHRlbXB0czogMwpjcnlwdG86CiAgZWQyNTUxOToKICAgIHB1YmxpYzogSVJ2cUFvUTRZV3FxVEwySVVSdWNQYkpIVlNMdzAvSVdMQ3p2cmlIbGhmYz0KICAgIHByaXZhdGU6IEV4TFBGSWlPTEI2ZmxsQzBMeXNlVXlpd0V5dTQwM2ordmsyR0QxdjJMS1VoRytvQ2hEaGhhcXBNdlloUkc1dzlza2RWSXZEVDhoWXNMTyt1SWVXRjl3PT0KICByc2E6CiAgICBwdWJsaWM6IE1JSUNDZ0tDQWdFQXJyN3dYRHQ2NHhHbXBPVXRlL0NpV28ybGsxM3NheElONStwMmJsYXR3emZVbVdsRVMwMVdYaDk1cmI3ZXpyKzlhNlJWRW9KOVY2dUVPRDhxTGVvSEJZSXpMb0I3d3J0TkFsT1hFWTRuaXF6Rm9WVXNpdTZSc3RmNDUrdXVUMUpnMjd0bjVwUlBFNUxRR2dMZlJ3K3JObUI5cHJVL3IrR29qazlRRzI0Y05mLzBNMHZuT1o0dDJML2ZTUW83WFhkM1U3QXNHNHIxYWVuR3lvUHdlVmdNWXkvOC84SzlaWUNMd3JjSUtZcU56T1grSkZBN2FHaDlOc3FRWU1TSUpoYWZLbFBIbHBGaWNVa3JjUGtmUFRiWU1ZYXU4MmZMYWh0Tjd4MC8yK21jdy85RzczUzRkNVJoNkNGZ3FVZ096aThGVXZmYXEvZTQyQU1CZkdQdXA0ODFxQ2UyS3hzRS83b0I1ZURSQU91c1pDbzgzeDl1VjVCakxva3FUWGw5V2NtYzdXOTBKM3VuTEVPK21yR1VaaENzd3p1RVJnZmc3YTJXMjV4NFBBZjI5aGU2eGpFWUNoaVYrRjdXUkhVUThGV2pWQUJuSWI2VVNNS1crYUI3a2xCejVmQ2VhRHRiWFRFR3YwMVhoOXhiNm0rNC9SbW1iZlZicjl0aHc5UWlWWTVtSkEwRnFGMnI0VDZ6TVJIa3ZtVCtUdDVBTUhuRmR6SldSWFRBVFZDSmZ4Q3FJTUN4OTRpZnE3YzhTTnF0OGo3MnhqanNMbGFDNVBFRUNKL2RrSnJ1aFJTWnM4YUlTZXZCSWR2SmVWaC9NTWRhaml5UW92VmpIVzhXUkh3Z0ZyZjJSbDB0MGczbHNHcUFHUTJxenk2c05jMjcrdWw5YjJZbzdKWUVyVzV6bjJrQ0F3RUFBUT09CiAgICBwcml2YXRlOiBNSUlKS0FJQkFBS0NBZ0VBcnI3d1hEdDY0eEdtcE9VdGUvQ2lXbzJsazEzc2F4SU41K3AyYmxhdHd6ZlVtV2xFUzAxV1hoOTVyYjdlenIrOWE2UlZFb0o5VjZ1RU9EOHFMZW9IQllJekxvQjd3cnROQWxPWEVZNG5pcXpGb1ZVc2l1NlJzdGY0NSt1dVQxSmcyN3RuNXBSUEU1TFFHZ0xmUncrck5tQjlwclUvcitHb2prOVFHMjRjTmYvME0wdm5PWjR0MkwvZlNRbzdYWGQzVTdBc0c0cjFhZW5HeW9Qd2VWZ01ZeS84LzhLOVpZQ0x3cmNJS1lxTnpPWCtKRkE3YUdoOU5zcVFZTVNJSmhhZktsUEhscEZpY1VrcmNQa2ZQVGJZTVlhdTgyZkxhaHRON3gwLzIrbWN3LzlHNzNTNGQ1Umg2Q0ZncVVnT3ppOEZVdmZhcS9lNDJBTUJmR1B1cDQ4MXFDZTJLeHNFLzdvQjVlRFJBT3VzWkNvODN4OXVWNUJqTG9rcVRYbDlXY21jN1c5MEozdW5MRU8rbXJHVVpoQ3N3enVFUmdmZzdhMlcyNXg0UEFmMjloZTZ4akVZQ2hpVitGN1dSSFVROEZXalZBQm5JYjZVU01LVythQjdrbEJ6NWZDZWFEdGJYVEVHdjAxWGg5eGI2bSs0L1JtbWJmVmJyOXRodzlRaVZZNW1KQTBGcUYycjRUNnpNUkhrdm1UK1R0NUFNSG5GZHpKV1JYVEFUVkNKZnhDcUlNQ3g5NGlmcTdjOFNOcXQ4ajcyeGpqc0xsYUM1UEVFQ0ovZGtKcnVoUlNaczhhSVNldkJJZHZKZVZoL01NZGFqaXlRb3ZWakhXOFdSSHdnRnJmMlJsMHQwZzNsc0dxQUdRMnF6eTZzTmMyNyt1bDliMllvN0pZRXJXNXpuMmtDQXdFQUFRS0NBZ0J6VDAvd3JOZEVhMnRadUZreFJmTDhhaWZ1ZkxYN1dXaVB0dW43bVhzRUxSMC9OblY0YzBvZ3hnaFhISEtPWDN3eFFibFpnMzRPa2dHbjFCYVRRYkRzYzZRdWRWNDFlNzh2WDlWNklpSDVvbFN2UnpNallwWUdPL25sb0dIZnVlNXNVTmdaRVppMHc5WktzOForYjlwOUFXTW8xTVYzM0NLTDljNVlxMm8yUC9YMnU0bVRQY3ZuRVlYWC9zWjV3TkdmQ2N1eFNScjBqdTA4eVordmt1aHBzMHJ4d3FHVUR5VXFrZmp5NEpqOXNtN25xNEhvUGJzU29zeHU3b0VoRVNCcW4rbytjeVZRdUFYUWdMT2FnMHhhTWhQVVRwT3VLdUpjZlNLY2pTV0RPRHFvM0k2MWFkYkpoT3p5QjdpdFdkM2JoKzVtT0F0amoyZzFtd1BxMGRlSFRPZS84NXRLRW1xVkZOTkNGSkhjM2tDa0loMFFQM0UwZVgweTFKbFVJVWh1ZWh5QkFPMG0zTloyQ2puczBWaXJLdmxGc2pQYU1RR2wvOUdJdmNxNzdKL2VINU9WT2lTS0N4ZzRyc2JuUHdrTUhkREJtNEdlOFovNklWcWEzNGJrTFA2UGZFN2ZBdWlabHp4b0kvUVQxUTAxeEQ0SGZDSmlSZDN5dW53Yit2elJQS2QxTTFjUkpNWVJtaHFUUmxNVm1iRXV2Y3YvOFhJcnNRdUx3UFIrdWJlTWt1K3ovbVlzT09pazROdjVKaGZpcndqelkvUmhoZ2UzZzlDdW5KUGtWMXQxV1U1NjREejhpT2ZCNU8yVmpydWJTWitRb2RGZWR2cUVjclJpc3NCSENKeEowRGcvRHFNbUFIeEtDWUswZU11YTc4NXVjaEhHTEZOeTVQWVFBUUtDQVFFQXcrYUpxd2Rpc2pGaGJ5QnVNNEwzTlNGUVBGWGEyVUlYNG4zQVNMaHhYRU5ZNndDcEpKTnBscWlxR0VlaWZKTDJIQUtQR3FxbHJ6S1RzMFpBWmM5T1RrQ0hOM1p1cHlYTDFUUUFLaXhGaXFKUEduSnowaDBmcDN1cFk5Vkljd251UFJ1M0tDUTFVMm81WUxWOGdobi9aSmdnYTc5cGVZam5yUlhMZlJPMXBqUmdGN05OLzk0eHJmelNiclBVdTBWVCtYUXRUNGlySEdTZ1RaeVFzUWlSblBQUHhFdjRLTFFiYk0yQm1vcm1Gb0ZONjNUUW9xZVdtWjZyTzU5ekFBK3VyZCtLdEhRSDZyMHVUSGV4MUNxN25SZVR3RTdSaUw3MXhNcldJV1hPbUpOem5sWXE5aW12ZzNWeTVhOGk5amU4V3h6Nm4vUGdLMERRb3RmUldjUjBhUUtDQVFFQTVGcjVOS0laRW5FNTYyZ3h4OWxpUVF3bks3dnpFYno4OTdjeGNBTnpTVG1kbUVtMHlzNE5YcmJDU3AzUExHZGtnM3lNZGx4TGNoajlPMnZydjhlaEJNNGliQkkzbzlESDl5VXl3N29kNVAxSWI2RVM5VkJmWHA3V1NPa2hyb1VqOGZWSzhkQ1lxOXAyanRldUNKUEdwSmdtUUdvT1R5Mm9WL2czT2tKVjhOVVRIbDArOXpiK050NTNpOVRJamh5QVRqdU1IWmE2eXJkNDRQWUlXQXBjQVhBcXh4N0VaQllyWGRzVndtOUJ0T0RHdUdhSE1acEdzTmlRT0dDSG9UbWptb0JiYUJTV2wxUEthMHA0UmRWb2FZOG0zREV1c3BabFpKcGc2TjFkYlRBUjFPRVdDUWVaOUgxaEg2dVR2LytEdlM4b1NLRWtTNG9kc0k3YmxNUnpBUUtDQVFBTUNBZWllbVNrWHdZRjVpNytlT2VuMnJEcjA3WUtLOVg5c2cxeUtlbkVhZHAzTEdZMitkcTlSd1NUVXlyMmphd1IwbEpwcDl0ZkpETVFDcHQvNVRpQTg5T2FJMnJ1VnhMcXVEUGVZek91TFFQQXN4REw4Yi8wOEZKWjhFcHZ6a2RVZDNSTFFkWUlsbmlKcVB2Sm5jRWlzM2tpUlBJOFpaMGM4ejY1SXRIQU1HMUtaMWUrQkM1MjZoVWVlV3J5U1hLNzJsZkNEN202bDYrRXRMM3FNWVdINXkxMmQ5ZjQzLzdqTXNmbjd1bnNyZXBVTUt0em9lbE03QUxHT2FlOWREa2RNcUo1TExzanZwU3VXNWVQV1VTR2hHRXRxV21UQlc5Z3M3aHMrcXl5a0RQRW9MUW94Q3lrWFQwK1FBQmNzTldmbnVzQmtkL05xRUJvRCtzcW9UY3BBb0lCQURrbWs0d2FyWSt5Q3I3aDJ1T2JnajJwWHZ4UkU2cHkxQlRqSWxwWVlyZ0cxV3hSdGcrenRpRG9PSVFZTHN0OExPbkRlQnYvU1ZxSzZvVytvc2ZpbkdmcGR5LzQ5emZtZnNWWjUvU1lWZmNEZE9lTE5vVnkwZ3VLVVRMNk5kWEp1STlMeHEveWR1TTd6OFE4TW5Bdkc5NEJ2a0VNeWZ3Qy8walU5RzErUUtmL2k4TmpydWlNT045ZW1pakMzbGJDeDFITkVXb3VXUjEzQWFlN3E2YnRJTTJ6VnVGeXo5QUV4R0crL1JrbVl4bHowQWhDa0w5WFR5M2ZaV2pXcjlzbjQ4dzlKNk5LMDgyWHlPZEZRZ2lvT25PQXdrY0ZnQnh1QzM0OExOamEzaEQvb05iWVpuMW9DNTNtNnpIVDdTeDJOSEJhcHdoV1hCRVR4ZzUwRW55UEZnRUNnZ0VCQUtpY1l3QVU5alZTbzZCWTZ3S0k0b2VsVGo0VEpZdlBEK095U1U4THkzNG02T3lJc00vWW1jUjVOY2VYYWIyYkFZTjlCdlcrY1l4SW9kZXR2bHNTb2FyQ3ppUFdvWGJ0QzhpL3FxZ2J1eThyNjVvZ3pPNXNkN2Y2WWRveTNMNm5lMURjam1wd084VXVaU1E0UGswWHBjR3RFZExoZ0thcmFzUkVZbFZxOFo0eFNtOTdDODNMR0p0aHl1RDFRQXB1Ly8wT3AxV0ZZampRcHB5WG45blUxMlFlNWVsMGRjZk9ES1MwOW5UZ1hQOE9Qa0d5WWw2TCt1UDh3ZXV4MkZRSmJsY2F2b1hKUG1SSmJqOU1VcU5Fa2NpUjJHdC9aQnc3ME9EeWRvR0hvUFZrRVBQd1JyVjd2TEpSZ0dyMHNYaUo5NVFIRU1udTh6dnJKb212d0FLL0NxOD0KZW52aXJvbm1lbnQ6IHByb2R1Y3Rpb24KaGVhbHRoOgogIGR1cmF0aW9uOiAxcwogIHRpbWVvdXQ6IDFzCnNlcnZlcjoKICB2MToKICAgIGlzc3VlcjogaHR0cHM6Ly9hdXRoLmZhbGtvd3NraS5pbwogICAgYWRtaW5zOgogICAgICAtIGlkOiBhZG1pbgogICAgICAgIGhhc2g6ICRhcmdvbjJpZCR2PTE5JG09NjU1MzYsdD0zLHA9NCRUbzdJT3lRZWswRXphL1YrY0dFNWlBJENzYXRnQTNzU012UE04WUpZNTNTWGFSWi9DbHlGTEFmRGJXclFXdWZFSlEKICAgICAgICAgICAgICAjIG97NndKVEVTdkF5L1o4YWxrQzBdYmpzUWQyKn56Zn1ER3A9KWVMdFhnI25WNTFJUnJQOTc0WTNtS0J4cSVPV2kKICAgIHNlcnZpY2VzOgogICAgICAtIGlkOiBlMTYwMmUxODVjYmEyYTkwZDhiYmNmYzNmM2M1NTMwYwogICAgICAgIG5hbWU6IGRldmVsb3BlcgogICAgICAgIGhhc2g6ICRhcmdvbjJpZCR2PTE5JG09NjU1MzYsdD0zLHA9NCRLK1FtTXJxZXhidG5XWUdoU3doN0JRJGw4dk1jZ2Y4eUFXUlgxV041RGVQTXZkMVI3Q2o3U0NSdGFnZUFSczU0aXcKICAgICAgICAgICAgICAjICRWekxfLUhkUDNZN29FKDY0P2pmQElyYXV8QkohPGVpMCk1MVdjRGhuUWtaQTJOdFhNVDh5T2JHVXNndktSbDkKICAgICAgICAgICAgICAjIGppcHRHZnBwUjVVOXVWSFNEUERNbG5vT2ZUeXNVZnJ1dUVuZ3ZKRG5vL0xnRHQzWWlZVCsvV01CUnIvVjkxZHNYQ2NTWWZ1dDZwZ1VXaDVldkJyRDRtWEdvQ2M4enJsSU0rZmxsZ2NHUE51R1NZazIxUTlDM0pLYUJtNjE3dU9WM25JdDFrSlQvVktySkdUZnFPZWlSY1BnMysxMVVyajQvUjhOZnl3WkNoQVF0ZWtvWktqR2VCNFM5ZytvVE5EeE9rU1dmWXlZM2ZpR2h4UWY0UjRLcFhhSkZQNGpFV05vVE5zbHdUTVNiRkFkRitqMitOZTNyQTFqU1VKdmtVWnhqUDBzblVrYlNETEIvQmlya1pCVURIT25WUE9wZExaY2tHZkRwVTNOZS8rWkpaQU9BRUNrREJ1ek12K29PcHRSZ0svQVN4VUVzNVJXQzlBek9qRkoyVmRvVUozeXFwcXUwKzNybjNxQXI4WUNVd1VEWUxRUzU3VEg5RVNhdy9OTFc5UWpxbitrdTh5OXpxbWZxUlJ4NC9seGttVi9nVHhKdVpIRTJBSmRpcmt6anA2UUtUdTNEVENuM3FTcWxXVm5tRTZabzhzSDNZQ0JQem9qZjU3RGVaTGpQMmpnVnpzSXFUdFJUN2QvcVhINys3QjFmNGJCOU1oVWhiSU16SERxOTdab214K0pEcm9iSzViQXROSFlaVjRjSnVrV3dselpERVlMTkdVYnV1S1hpRXI4QXVYaWx3TmhpNHZVRFl6cS9yL1VSb2oyM2pNUkpIL2NiMktxMktDSFBzMXUzNjJUbUFHUk4xL3liUVpkdXdTUUhEbXhhV1RJYzBsQTBaQkxXdmJGcUxuTlBGNWx5M3N3bjVFREJkWCtaZTNzTXRoeldTUGNnVHMwdG9nPQogICAgICAgIGR1cmF0aW9uOiAyNGgKICAgICAgLSBpZDogN2U4YzI0Mzc5OTMwZDEwN2IyZDI4MWFhMjMyNDcwOTIKICAgICAgICBuYW1lOiBrb25maWcKICAgICAgICBoYXNoOiAkYXJnb24yaWQkdj0xOSRtPTY1NTM2LHQ9MyxwPTQkd25QVUZObmpRL0REbkZDYjRJbGlqdyQzN25NM2NtRVEzYU96N2w1bDF1M1ZrZHR3cjRCVjg4OXJ2NTJOdVhURTJnCiAgICAgICAgICAgICAgIyAwSmxqQHZOcEJvPFFMQ21aRkh4ZFRWXiFlR1UtMmk2QSVxNy5me3k5UGhPTUkzd2IxYX0/bms1NDhnS3VydFJFCiAgICAgICAgICAgICAgIyBpdEN5YVAxa3BYQVFZRTJ1RC94OTZmYThqd0lHazhveHF1WVlHNHVvMEEva3M0RnpuT0p6ZFNmSFFJalNObkhjOFFzUURyMzQwMERuRUlzUWx1MCtQVnJDdksrSGNiaENtV1RWOTU2UTRpcWtpNmZMQ1pSV0hBSWdtYmxFZVBueWw1NE9yZGs3M3JuYjdmYnZieHZlTDFmeTk1bFVKdXR0Z1RzUG1MUExLWkNiK0hOaFU0YnFSZERmWVBLY21FL3graFJJalQ4UlJUZ3JRZ041dEhrdjY3RlNZdkM5SE42ZmN3bjdOSmVRbG5FaWFzSkFjcGpnZEVJYXo2bVJmdWZQSUd0RlVXajBwb2JIcDZCMkEyZVY2Q0NFaFhKZ1EzaVVGWTZzdGg3bHYvMHk1aVVhSnBzQk1EbWcyZERWalBKYk1QMjJGanBwdEl4SkxoNjI0TCtCMlRKeFFMMStlNmVQR05zR1poWjQ4R3MwdnM4eWJ5WHpwa1J4Z0kvRnM0MVN2bUFmSituUHY5V2lVeEViUU5YRVZNK0NYejkzdnJzWDZ3cGkxRndtaGVGdkd5ajJnRGJFTzFPV3V3V0FHTlZSYjJZbExyTmpNR0U1U2hUaHlJV2R2REJPOTZTR1hRdm1BRkNxRjE5OXZzZ2U4ZUFtZEsyUEJBTWlIMTkyc2lobzBzT1Y4c1dEblBIL3A0bmUzaS9lamZhWUhNbzFNVEpLanFnTG5uY25ndDRROS9tV0xqcDdoY293NXNXOCtaTlFvNFJ5TGJRM05FbmRjNi9OVkFQM2VLdVZYbmxrUUp4dm1ZVlMyVUtaeTJUT3RCTlpnMjhKU0M3NkhQOHNmOWFPUXE1VXN1c1IyMnJrZ0YrU0tNcUN4ZG5mSlVqZTFBbG1GY2gyYUNpaGU5QT0KICAgICAgICBkdXJhdGlvbjogMjRoCnRlbGVtZXRyeToKICBsb2dnZXI6CiAgICBsZXZlbDogaW5mbwogIG1ldHJpY3M6CiAgICBraW5kOiBwcm9tZXRoZXVzCiAgdHJhY2VyOgogICAga2luZDogb3RscAogICAgaG9zdDogaHR0cDovL2xvY2FsaG9zdDo0MzE4L3YxL3RyYWNlcwp0b2tlbjoKICBraW5kOiBhdXRoCnRyYW5zcG9ydDoKICBodHRwOgogICAgcG9ydDogNTAwMAogICAgdXNlcl9hZ2VudDogIkF1dGgtc2VydmVyLzEuMCBodHRwLzEuMCIKICAgIHJldHJ5OgogICAgICB0aW1lb3V0OiAxMHMKICAgICAgYXR0ZW1wdHM6IDMKICBncnBjOgogICAgcG9ydDogNTAwMQogICAgdXNlcl9hZ2VudDogIkF1dGgtc2VydmVyLzEuMCBncnBjLzEuMCIKICAgIHJldHJ5OgogICAgICB0aW1lb3V0OiAxMHMKICAgICAgYXR0ZW1wdHM6IDMK
      - image: grafana/mimir:latest
        command: -server.http-listen-port=9009 -auth.multitenancy-enabled=false -ingester.ring.replication-factor=1
    working_directory: ~/konfig
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - run: dockerize -wait tcp://localhost:8200 -wait tcp://localhost:4566 -wait tcp://localhost:5001 -wait tcp://localhost:9009 -timeout 1m
      - restore_cache:
          name: restore go deps
          keys:
            - konfig-features-http-go-cache-{{ checksum "go.sum" }}
            - konfig-features-http-go-cache-
      - restore_cache:
          name: restore ruby deps
          keys:
            - konfig-features-http-ruby-cache-{{ checksum "test/Gemfile.lock" }}
            - konfig-features-http-ruby-cache-
      - run: make dep
      - save_cache:
          name: save go deps
          key: konfig-features-http-go-cache-{{ checksum "go.sum" }}
          paths:
            - /home/circleci/go/pkg/mod
      - save_cache:
          name: save ruby deps
          key: konfig-features-http-ruby-cache-{{ checksum "test/Gemfile.lock" }}
          paths:
            - test/vendor
      - restore_cache:
          name: restore go build cache
          keys:
            - konfig-features-http-go-build-cache-{{ checksum "go.sum" }}
            - konfig-features-http-go-build-cache-
      - run: make features-http
      - save_cache:
          name: save go build cache
          key: konfig-features-http-go-build-cache-{{ checksum "go.sum" }}
          paths:
            - /home/circleci/.cache/go-build
      - store_test_results:
          path: test/reports
      - store_artifacts:
          path: test/reports
      - run: make -C test leave-coverage
      - persist_to_workspace:
          root: test
          paths:
            - reports
    resource_class: large
  features-coverage:
    docker:
      - image: alexfalkowski/go:1.22-ruby
    working_directory: ~/konfig
    steps:
      - checkout
      - attach_workspace:
          at: test
      - run: git submodule sync
      - run: git submodule update --init
      - run: make coverage
      - store_artifacts:
          path: test/reports
    resource_class: large
  release:
    docker:
      - image: alexfalkowski/release:3.1
    working_directory: ~/konfig
    steps:
      - checkout
      - run: release
    resource_class: large
  push-docker:
    docker:
      - image: alexfalkowski/go:1.22-ruby
    working_directory: ~/konfig
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - setup_remote_docker
      - run:
          name: make login
          command: echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
      - run: make push-docker
    resource_class: large

workflows:
  konfig:
    jobs:
      - build-service
      - build-docker
      - features-grpc
      - features-http
      - features-coverage:
          requires:
            - features-grpc
            - features-http
      - release:
          context: gh
          requires:
            - build-service
            - build-docker
            - features-coverage
          filters:
            branches:
              only: master
      - push-docker:
          context: docker
          requires:
            - release
          filters:
            branches:
              only: master
